---
author: yingyun001
layout: post
title: "Ansible From Zero To One"
date: 2015-10-23 11:00
category: Tools
tags:
- ansible
- open source
---

如是说，什么事情从0到一都是艰难的。但我感觉 Ansible 的挑战更大了一点。好吧，就从安装开始吧。^_^

# 安装控制节点

## Prerequisites

* 控制节点端

在这里我们称安装了 Ansible 的机器为 Control Machine。既然是在学习 Ansible，那么系统一定是 Linux 吧，这个不用多说。必要的前提条件就是需要该台控制节点安装了 Python 2.6 或 2.7。（BTW：Ansible 就是用 Python 写的。）


* 被管理节点端

好了，我们已经说完控制节点安装的前提条件，下面就是被管理节点的安装条件了。既然要被管理（也就是要和控制节点进行通信），那么必须有一种通信工具才可以。Ansible 里推荐使用 SSH；当然在被管理节点中也需要安装 Python，版本在 2.4 及以上既可。

## Steps
这里我用了两台机器进行测试的，分别是 CentOS 7 & Fedora 22，仅举一例进行说明：

### 编译源码安装

1. `$ git clone https://github.com/ansible/ansible.git --recursive`

   `--recursive` 说的是在克隆完成后，使用默认设置对所有子模块进行初始化。相当于在项目克隆完成后立即运行 `git submodule update --init --recursive` 

2. 进入 ansible 目录中
   
   ~~~ bash
   $ cd ansible
   ~~~

3. 为了能够运行 ansible，我们需要执行 `env-setup` 脚本来设置环境变量。

   `$ source ./hacking/env-setup`
   
   > **BTW**
   > 如果您不想看到太多没用的输出，请执行 `$source ./hacking/env-setup -q`
   下面是脚本中的一些片段，一看便知：

   ~~~ bash
   PREFIX_PYTHONPATH="$ANSIBLE_HOME/lib"  
   PREFIX_PATH="$ANSIBLE_HOME/bin"
   PREFIX_MANPATH="$ANSIBLE_HOME/docs/man"
   # $ANSIBLE 就是您克隆的 ANSIBLE 项目所在的绝对路径。
   ~~~

   ~~~ bash 
   # 下面是设置环境变量
   expr "$PYTHONPATH" : "${PREFIX_PYTHONPATH}.*" > /dev/null || export PYTHONPATH="$PREFIX_PYTHONPATH:$PYTHONPATH"
   expr "$PATH" : "${PREFIX_PATH}.*" > /dev/null || export PATH="$PREFIX_PATH:$PATH"
   expr "$MANPATH" : "${PREFIX_MANPATH}.*" > /dev/null || export MANPATH="$PREFIX_MANPATH:$MANPATH"
   ~~~

   ~~~ bash
   # 在这里还需要打包有个Python egg，不然 pkg_resources 就不能正常工作啦！
   (
        cd "$ANSIBLE_HOME"
        if [ "$verbosity" = silent ] ; then
            gen_egg_info > /dev/null 2>&1
            find . -type f -name "*.pyc" -delete > /dev/null 2>&1
        else
            gen_egg_info
            find . -type f -name "*.pyc" -delete
        fi
        cd "$current_dir"
   )
   # 下面是定义的 gen_egg_info 函数
   gen_egg_info()
   {
       if [ -e "$PREFIX_PYTHONPATH/ansible.egg-info" ] ; then
           \rm -r "$PREFIX_PYTHONPATH/ansible.egg-info"
       fi
       python setup.py egg_info #这个就是打包过程啦！打好的包就在 $ANSIBLE_HOME/lib/ansible.egg-info。这里使用打包格式是 egg_info，欲知更多格式请执行 python setup.py --help-commands。
   }
   ~~~

4. 现在还需要安装一些必备的软件包。如果您不想用系统的包管理器来安装的话，可以通过 pip 来安装。
   
   ~~~ bash
   $ easy_install pip
   $ pip install pyyaml jinja2 nose passlib pycrypto
   ~~~

5. 运行了 env-setup 脚本后，主机列表就默认存在 /etc/ansible/hosts 中了。当然主机列表文件所在的目录是可以自定义的，后面我们会提到。

   ~~~bash
   # 我的 hosts 文件中写的是：
   [fedora22] # 组名
   192.168.9.50  # 被管理机器的 IP 地址
   [centos7]
   192.168.9.58
   ~~~

6. 一切就绪，我们可以来测试一下 ansible 是否安装成功了。
   
   * 利用密码的方式测试：
     ~~~ bash
     $ ansible fedora22 -m ping --ask-pass`  
     SSH password: 
     192.168.9.50 | SUCCESS => {
         "changed": false, 
         "ping": "pong"
     }

   * 利用 SSH keys 的方式测试：
     
     想用这种的方式，首先需要配置无密码登录。
     
### 软件安装
   

